# README.md

# Faravel

Учебный микрофреймворк в духе Laravel с жёстким MVC, «немым» Blade и без JS во вьюхах.

## Обзор ветки v0.4

Ветка **v0.4** Faravel представляет собой серию минорных обновлений, в которой
появились крупные возможности и улучшения:

- **SafeMode Admin** — единая админ‑панель `/admin/` с модулями диагностики
  и инсталляции. Доступ защищён ключом (переменная `ADMIN_KEY`).
- **Контрактная система** — файлы классов теперь содержат явные контракты
  (список публичных методов и их параметров) и используют интерфейсы
  `InvokableControllerContract` и `ServiceContract`.
- **Глубокое логирование** — класс `App\Support\Logger` обеспечивает
  структурированные логи жизненного цикла приложения (см. `storage/logs/debug.log`).
- **Тема Xen** — унифицированный дизайн: sticky‑navbar, мобильное меню без
  JavaScript, градиентные баннеры, современная типографика.
- **Корневая страница** — теперь отдаёт 200 OK и содержит заглушку с ссылкой
  «Войти» вместо мгновенного редиректа.

Полную историю изменений по конкретным версиям см. в файле
[CHANGELOG.md](CHANGELOG.md). README содержит лишь краткое описание
основных возможностей ветки.

## Что нового в v0.4.112

- **Корректное подключение стилей**: в базовых лейаутов темы Xen (`layouts.theme` и
  `layouts.xen.theme`) добавлен вызов `@stack('styles')` в секцию `<head>`. Это
  позволяет страничным шаблонам подключать дополнительные таблицы стилей через
  директиву `@push('styles')` (например, `forum.css`). Благодаря этому форум снова
  отображается корректно, как в предыдущих версиях.
- **Удалён временный RequestServiceProvider**: временный файл провайдера, который
  использовался для привязки `Faravel\Http\Request`, удалён. Все необходимые
  биндинги выполняются в `AppServiceProvider`.
- **Бамп версий**: версия приложения и заголовки модифицированных файлов
  обновлены до `v0.4.112`.

## Что нового в v0.4.113

- **Исправление 404 для стилей**: во всех лейаутах и страничных шаблонах пути к
  таблицам стилей заменены на `/public/style/...` вместо `/style/...`. Это
  гарантирует доступность файлов CSS независимо от конфигурации корня сайта.
- **Обновление шапок файлов**: версии лейаутов и форумных шаблонов подняты
  (в частности, `layouts.xen.theme`, `layouts.theme`, `forum/category`,
  `forum/topic`, `forum/hub`). В комментариях FIX указано изменение путей
  стилей для устранения 404.
- **Версия приложения**: `config/app.php` обновлена до `0.4.113`.

## Что нового в v0.4.114

- **Маршрутизация**: В `Router::executeAction` параметры маршрута теперь распаковываются
  и передаются в контроллеры по одному (используется `...$args`), что
  устраняет ошибку *Argument #2 ($category_slug) must be of type string, array given*.
  Категория/хаб/тема снова открываются корректно.
- **Статические файлы**: Каталоги `public/style` и `public/admin` дублированы
  в корень проекта (`/style` и `/admin`), благодаря чему nginx может обслуживать
  запросы к `/style/index.css` и `/admin/` при корневом монтировании. Пути в
  лейаутах и страницах возвращены на `/style/index.css` и `/style/forum.css`.
- **Восстановлена админка**: благодаря копированию каталога `public/admin` в
  корень URL `/admin/` снова работает, как и раньше. Ключ авторизации берётся
  из переменной `ADMIN_KEY` (или `SERVICEMODE_KEY` для совместимости).
- **Версия приложения**: bump до `0.4.114`. Прочие файлы получили обновлённые
  шапки и комментарии. Все изменения отражены в `CHANGELOG.md`.

## Что нового в v0.4.115

- **Исправлен главный маршрут**: домашний маршрут `/` теперь принимает
  только объект `Request` в замыкании, поскольку с версии v0.4.114
  параметры маршрута передаются по отдельности. Это устраняет ошибку
  `ArgumentCountError: Too few arguments to function …` при запросе `GET /`.
- **Версия приложения**: обновлена до `0.4.115`. См. `CHANGELOG.md` для
  подробностей.

## Что нового в v0.4.116

- **Реструктуризация проекта**: все исходники теперь находятся внутри
  каталога `forum`, который монтируется в контейнер Docker как `/var/www/html`.
  Это устраняет несоответствие между структурой архива и путями, ожидаемыми
  docker‑compose.
- **Копирование статики**: в каталоге `forum` созданы директории `style` и
  `admin`, скопированные из `public/style` и `public/admin`. Это гарантирует,
  что nginx обслуживает запросы к `/style/index.css` и `/admin/` вне зависимости
  от настроек корня сайта.
- **Исправление главного маршрута**: домашний маршрут `/` принимает
  только объект `Request` и возвращает шаблон `home`. Благодаря распаковке
  параметров в `Router` это окончательно устраняет ошибку `ArgumentCountError`.
- **Версия приложения**: обновлена до `0.4.116`. Все изменения подробно
  описаны в `CHANGELOG.md`.

## Что нового в v0.4.117

- **Приоритет ключа ADMIN_KEY**: SafeMode Admin теперь проверяет переменную
  `ADMIN_KEY` в первую очередь и использует `SERVICEMODE_KEY` только как
  резервное значение. Это отражает настройку по умолчанию в docker‑compose
  (`ADMIN_KEY: ${ADMIN_KEY:-myadmin}`) и упрощает управление секретом.
- **Новые админ‑модули**: добавлены две утилиты в админку:
  - *Проверка стека* (`/admin/?page=stack`) — статический анализ исходного кода,
    сверяющий объявленные в шапках файлов контракты с фактическими публичными
    методами классов. Помогает поддерживать архитектуру чистой и избегать
    несоответствий.
  - *Контроль файлов* (`/admin/?page=checksum`) — вычисляет SHA‑256‑хеши всех
    файлов проекта, сохраняет их в зашифрованном виде (используется ключ админки)
    и сравнивает с текущим состоянием. Отображает древовидную структуру
    изменений и подсвечивает новые, изменённые и удалённые файлы.
- **Формы входа и регистрации**: поля `_token` теперь используют
  функцию `csrf_token()`, что устраняет ошибку «CSRF token mismatch» при
  отправке форм.
- **Версия приложения**: bump до `0.4.117`.

## Что нового в v0.4.118

- **SafeMode вынесен в отдельный путь `/safemode/`**.  Аварийная админка теперь
  работает независимо от ядра: она загружает только минимальный бутстрап
  (`framework/init.php`, `framework/helpers.php` и `app/init.php`) и
  подключает модули из каталога `public/admin`.  Это обеспечивает доступ к
  диагностике БД, инсталлятору, проверке стека и контролю файлов даже если
  основное приложение не стартует.  Старый URL `/admin/?page=service` для
  сервисных модулей больше не используется.
- **Новая админ‑панель `/admin`**.  Теперь страница админки обслуживается
  полноценными контроллерами (`AdminController`, `AdminCategoryController`,
  `AdminForumController`) и защищена middleware `AuthMiddleware` и
  `AdminOnly`.  Администраторы (role_id ≥ 6) могут управлять настройками,
  категориями и форумами через удобный web‑интерфейс.
- **Раздел модератора `/mod`**.  Пользователи с ролью id ≥ 3 (модераторы,
  супер‑модераторы и разработчики) получают ссылку «Модератор» в
  навигации.  Пока что это простая заглушка, но в будущем здесь появятся
  инструменты для модерирования тем и постов.  Доступ к разделу
  контролируется middleware `ModOnly`.
- **Роль‑ориентированная навигация**.  `LayoutService` теперь определяет
  `role_id` авторизованного пользователя и показывает ссылки «Админка»
  (для администраторов) или «Модератор» (для модераторов) в зависимости
  от роли.  Гостям и обычным пользователям эти ссылки не отображаются.
- **Автозагрузчик в SafeMode**.  Страница `public/admin/index.php` подключает
  `app/init.php` перед загрузкой модулей.  Это устраняет фатальные
  ошибки типа «Class App\Services\Admin\ChecksumService not found» в
  модулях проверки стека и контроля файлов.
- **Версия приложения**: bump до `0.4.118`.

## Что нового в v0.4.120

- **Исправления Blade‑шаблонов**: устранена ошибка компиляции вида
  «Unmatched '}'» в шаблоне навигации (`layouts.xen.nav`), которая возникала
  из‑за старой версии файла.  Навбар снова корректно рендерится.
- **SafeMode модули**: описание и управляющие кнопки в модулях
  «Проверка стека» и «Контроль файлов» скрыты в collapsible блоки `<details>`
  с заголовком «Описание».  Это позволяет уменьшить визуальный шум.
- **Проверка стека**: модуль теперь отображает результаты в виде
  древовидной структуры (аналогично модулю контроля файлов).  Каждая
  директория показывает количество файлов с несоответствиями/общее число
  файлов, а каждый файл раскрывается для просмотра недостающих и
  лишних методов.
- **Версия приложения**: bump до `0.4.120`.

## Что нового в v0.4.110

- **Возвращена AppServiceProvider**: главное обновление — снова подключён
  `AppServiceProvider`, который регистрирует в контейнере `Faravel\Http\Request`
  и `Faravel\Http\ResponseFactory`. Это устраняет ошибку 500 вида
  *«Container binding [Faravel\Http\ResponseFactory] not found.»* и избавляет
  от необходимости в отдельном `RequestServiceProvider`. Конфигурация `config/app.php`
  теперь включает `AppServiceProvider` и исключает временный `RequestServiceProvider`.
- **Включён режим debug по умолчанию**: параметр `debug` в `config/app.php`
  установлен в `true`, что включает журналы запросов без дополнительной настройки.
- **Актуализация домашнего шаблона**: переименован файл `resources/views/home_redirect.blade.php`
  в `home.blade.php`, обновлён маршрут `/`, который теперь возвращает правильный
  шаблон через `response()->view('home')`. Сам шаблон показывает заглушку
  с гиперссылкой «войти» на форум.
- **Унификация поставщика Request**: файл `RequestServiceProvider` оставлен
  для истории, но исключён из конфигурации. Биндинги Request/ResponseFactory
  теперь выполняет `AppServiceProvider`.
- **Обновления документации**: все версии файлов и конфигураций обновлены до
  `v0.4.110`, описания приведены в актуальное состояние; перенесённые изменения
  отражены в `CHANGELOG.md` и `TODO.md`.

## Что нового в v0.4.108

- **Домашняя страница‑заглушка**: маршрут `/` отдаёт статичную страницу с
  гиперссылкой «войти», ведущей на форум. Это решение избавляет от ошибки 500
  и избавляет от авто‑редиректа, сохраняя код ответа 200.
- **Расширенные логи**: система отладки через `App\Support\Logger` использует
  символ табуляции (что делает строки легче читаемыми) и дополняет сообщения
  об ошибках сведениями о методе/пути запроса, файле и строке, где произошло
  исключение. Кроме того, `Logger` создает директории/файлы логов с правами
  0775/0664, чтобы веб‑сервер (`www-data`) мог записывать в них.

## Что нового в v0.4.8

- **Глубокий дебаг**: добавлена система простого логирования через класс
  `App\Support\Logger`. При включённом режиме `app.debug` запросы
  записывают шаги жизненного цикла приложения: регистрация провайдеров,
  загрузка маршрутов, бутстрап, диспетчеризация маршрутов, выполнение
  middleware и контроллеров. Логи сохраняются в `storage/logs/debug.log`
  в читаемом виде (например, `[APP.PROVIDER.REGISTER] App\Providers\CacheServiceProvider`).
  Это упрощает диагностику ошибок 500 и других проблем. Чтобы активировать
  логирование, установите `debug` в `true` в `config/app.php`.

## Что нового в v0.4.7

- **Домашний маршрут**: главная страница (`/`) теперь отвечает кодом 200 и
  выполняет перенаправление на `/forum/` через HTML‑мета‑refresh. Это
  устраняет ошибку 500 и удовлетворяет требованиям тестовых запросов.
- **Контрактные интерфейсы**: добавлены контракты `InvokableControllerContract`
  и `ServiceContract` в каталоге `app/Contracts`. Они задают унифицированные
  сигнатуры для контроллеров и сервисов. Уже существующий контракт
  `ViewModelContract` остаётся неизменным.
- **Обновлённая система контрактов**: переработан документ `docs/Contracts.md`,
  описывающий файл‑хедеры, планы канонизации и новые интерфейсы. Новые
  классы должны реализовывать или ссылаться на соответствующие контракты.
- **Реорганизация документации**: каталог `docs/` приведён к единой
  структуре, добавлен индекс `docs/index.md`, обновлены ссылки в README.

## Что нового в v0.4.6

- **SafeMode Admin**: единая админ-панель `/admin/` (единая точка входа `public/admin/index.php`):
  - проверка ключа 1 раз за сессию (используется `SERVICEMODE_KEY`, при отсутствии — `ADMIN_KEY`);
  - модули «Проверки БД» и «Инсталлятор» подключаются в общем каркасе (константа `ADMIN_ENTRY`);
  - подключаемые файлы начинаются с `_` и **недоступны** напрямую.
- **Инсталлятор**:
  - операции `connect/create/drop` на базе `Faravel\Database\DatabaseAdmin`;
  - миграции/сиды через **единый раннер** `framework/migrator.php`;
  - управление `public/installed.lock` (создание/удаление).
- **CLI-мигратор**: `php tools/migrate.php --migrate|--seed|--fresh [--json]`
  — чистый JSON-вывод для CI/Docker.
- Обновлена документация: `docs/Admin.md`, `SECURITY.md`, `CHANGELOG.md`.

См. подробности в [CHANGELOG.md](CHANGELOG.md).

## SafeMode Admin (аварийная панель)

Откройте /admin/, введите ключ (из SERVICEMODE_KEY либо ADMIN_KEY).

Выберите модуль:

Проверки БД — ping/exists/connect/create/drop/report

Инсталлятор — connect/create/drop/migrate/seed/fresh и installed.lock

Документация: docs/Admin.md

Безопасность: SECURITY.md


Миграции/Сиды из CLI
php tools/migrate.php --migrate
php tools/migrate.php --seed
php tools/migrate.php --fresh
# Для CI:
php tools/migrate.php --migrate --json

Структура

public/ — публичный корень (включая /admin/)

framework/ — ядро Faravel (migrator.php и пр.)

app/, routes/, resources/ — приложение

database/ — миграции и сиды

tools/ — CLI-утилиты (мигратор и т. п.)

docs/ — документация

## Документация

Полный набор руководств и спецификаций находится в каталоге `docs/`. Для
удобства навигации создан индекс [docs/index.md](docs/index.md), откуда
можно перейти к описанию SafeMode/Admin, архитектуры, контрактов,
форумных данных, VM и других тем.

## Лицензия

MIT. Подробнее см. LICENSE.