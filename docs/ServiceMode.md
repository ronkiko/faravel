# SafeMode — аварийно-сервисный режим

SafeMode предназначен для случаев, когда основное приложение Faravel не может загрузиться
(например, не создана или недоступна база данных). SafeMode работает без полного бутстрапа
и опирается на низкоуровневый помощник `Faravel\Database\DatabaseAdmin`.

## Где найти

- Веб-страница: `public/service/index.php`
- CLI-утилита: `tools/recovery/db_recovery.php` (запуск: `php tools/recovery/db_recovery.php --help`)
- Низкоуровневый сервис: `framework/Faravel/Database/DatabaseAdmin.php`

## Ограничение доступа (SERVICEMODE_KEY)

В продакшене рекомендуется ограничить доступ к SafeMode.

1. Задайте переменную окружения (или в `.env`):

SERVICEMODE_KEY="сложный_секретный_ключ"

markdown
Copy code

2. Откройте SafeMode с параметром `?key=...` один раз:

/service/?key=сложный_секретный_ключ

perl
Copy code

После успешной проверки ключ сохраняется в сессии; ключ **удаляется из URL** (редирект).
Дальнейшая навигация (`Диагностика БД`, ping и т. п.) не требует повторного ввода до
окончания сессии. Чтобы сменить ключ — перезапустите браузерную сессию или измените
`SERVICEMODE_KEY`.

> Если `SERVICEMODE_KEY` **не задан**, доступ в SafeMode открыт (для локальной разработки).

## Возможности

- «Рецепты» (best practices) по подготовке БД до загрузки приложения.
- Диагностика БД: ping сервера, проверка существования БД, создание/удаление БД,
  проверка полного подключения (dsn с базой).
- Работа без JS, минимальный UI; можно использовать в «голых» контейнерах.
- CLI-режим с JSON-выводом для CI/CD.

## Поток работы

1. Зайдите на `/service/` (или `/service/?key=…`, если включён ключ).
2. Откройте «Диагностика БД», заполните параметры подключения (они сохраняются в сессии).
3. Выполните нужные действия (ping/exists/create/drop/connect).
4. После восстановления — удалите `public/service` с продакшена.

## Безопасность

- Не логируйте пароль; используйте ENV/секреты в проде.
- Операция «drop» разрушительна; запускайте её осознанно.
- Дополнительно ограничьте `/service/` на уровне веб-сервера (basic auth/ACL), если нужно.
