# docs/ServiceMode.md

# SafeMode — аварийно-сервисный режим (обновлено)

SafeMode нужен, когда основное приложение не может загрузиться (например, БД недоступна).
До версии v0.4.117 сервисные инструменты находились внутри админки.  Начиная с
v0.4.118 SafeMode выделен в отдельный путь `/safemode/`, который работает
независимо от ядра и MVC‑контроллеров.  Это позволяет выполнять
диагностику и инсталляцию даже если основной код не загружается.

## Где найти

С версии **v0.4.118** SafeMode больше не встроен в админку.  Аварийные
сервисные модули вынесены в отдельный путь:

- **Новая точка:** `public/safemode/index.php` (или просто `/safemode/`).
  Внутри доступно меню с пунктами «Проверки БД», «Инсталлятор»,
  «Проверка стека» и «Контроль файлов».
- **Старый путь:** `public/admin/index.php?page=service` использовался
  до v0.4.117; теперь он предназначен только для MVC‑админки и не
  содержит сервисных модулей.
- Низкоуровневый помощник: `framework/Faravel/Database/DatabaseAdmin.php`.

## Доступ (ключ) и сессия

- Используется `SERVICEMODE_KEY`, при его отсутствии — `ADMIN_KEY`.
- Ключ вводится **один раз** на странице входа `/admin/` и запоминается в сессии.
- Смена ключа: завершить сессию (кнопка «Выйти») либо перезапустить браузерную сессию.

> Рекомендуется ограничить `/admin/` на уровне веб-сервера (BasicAuth, allow/deny по IP).

## Что внутри «Проверок БД»

- **Диагностика соединения:** `ping`, `canConnect`
- **Работа с БД:** `exists`, `create`, `drop` (для create/drop требуется подтверждение)
- **Отчёт:** `testReport()` — сводная информация о доступности сервера/БД/правах

Все операции выполняются через `DatabaseAdmin`, без прямого PDO и без загрузки всего ядра.

## Инсталлятор

Инсталлятор также перенесён в админку (`/admin/?page=install`):
- Конфигурация БД с подхватом из ENV.
- `create/drop`, проверка подключения.
- Если в проекте подключён миграционный раннер (например, `framework/migrator.php` с функциями
  `faravel_migrate_all()` и `faravel_seed_all()`), становятся доступными кнопки **Migrate**, **Seed**,
  а также **Fresh** (drop + migrate + seed).

> Если раннер отсутствует — модуль сообщит об этом и предложит воспользоваться CLI.

## Примечания

- Старые ссылки на `/service/` остаются рабочими: они корректно перенаправят в админку.
- Держите ключи в `.env`/секретах и не коммитьте их в репозиторий.
