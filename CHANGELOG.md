# CHANGELOG.md

# Changelog
## [v0.4.116] — 2025-09-13
### Fixed
- **Структура проекта**: исходники теперь находятся внутри каталога `forum`.
  Это исправляет ошибки, возникавшие из-за несоответствия путей при монтировании
  `./forum` в контейнер Docker. В результате `public/index.php` и другие файлы
  оказываются в правильных местах, и веб‑сервер их находит.
- **Главная страница (/)**: окончательно исправлена сигнатура замыкания для
  корневого маршрута. Теперь в функцию передаётся только объект `Request`,
  а параметры маршрута распаковываются в `Router`. Это устраняет
  `ArgumentCountError` при вызове `/`.
- **Доступность статики**: каталоги `public/style` и `public/admin` копируются
  в корень `forum` как `style` и `admin`. Благодаря этому nginx отдаёт файлы
  `/style/index.css` и страницы `/admin/` независимо от точки монтирования.

### Added
- **Реструктурированный архив**: в поставку добавлен каталог `forum`,
  содержащий полный набор исходников, а также дубликаты статики (`style`) и
  админки (`admin`) для корректной раздачи.

### Changed
- **config/app.php**: версия приложения обновлена до `0.4.116`.
- **routes/web.php**: обновлены комментарии и версия файла, отражающие новую
  сигнатуру главного маршрута.
- **README.md**: добавлен раздел «Что нового в v0.4.116»; существующие
  разделы сохранены.
- **packaging**: изменён способ упаковывания — теперь корень архива содержит
  каталог `forum` с исходниками, а также дубликаты статики и админки.

---
## [v0.4.117] — 2025-09-13
### Added
- **SafeMode модуль «Проверка стека»**: новая админ‑страница (`/admin/?page=stack`),
  которая анализирует файлы в каталогах `app/` и `framework/` и сопоставляет
  объявленные в шапках контрактов методы с фактическими публичными методами
  классов. Результаты выводятся в таблице; выделяются недостающие и лишние
  методы.
- **SafeMode модуль «Контроль файлов»**: ещё одна страница (`/admin/?page=checksum`),
  позволяющая вычислять SHA‑256‑хеши всех файлов проекта и сохранять их в
  зашифрованном виде. При открытии страницы текущие хеши сравниваются с
  сохранёнными, отображается древовидная структура изменений с подсветкой
  новых, изменённых и удалённых файлов.

### Changed
- **Приоритет ключа админки**: функция `admin_resolve_key()` теперь сначала
  обращается к переменной `ADMIN_KEY`, а `SERVICEMODE_KEY` рассматривает
  только как резервную. Это согласуется с настройкой по умолчанию в
  `docker-compose.yml` (строка `ADMIN_KEY: ${ADMIN_KEY:-myadmin}`) и
  упрощает конфигурирование.
- **Меню админки**: в `public/admin/index.php` добавлены новые пункты
  «Проверка стека» и «Контроль файлов», подключающие модули `_stack.php` и
  `_checksum.php` соответственно.
- **CSRF‑токены**: во вьюхах входа и регистрации теперь используется
  `csrf_token()` для генерации скрытого поля `_token`, что устраняет ошибку
  «CSRF token mismatch».
- **config/app.php**: версия приложения обновлена до `0.4.117`.

### Removed
- **Дубликаты статики и админки**: в этой версии каталог `style` и `admin` в
  корне больше не обновляются; все стили и файлы SafeMode берутся из
  `public/style` и `public/admin`. Это возвращает структуру стилей «как было».

---
## [v0.4.118] — 2025-09-14
### Added
- **Перенос SafeMode**: аварийный сервисный режим теперь доступен по адресу
  `/safemode/`.  Новая страница `public/safemode/index.php` загружает
  минимальный бутстрап и автозагрузчик приложения и подключает существующие
  модули (`_service.php`, `_install.php`, `_stack.php`, `_checksum.php`)
  из каталога `public/admin`.  Это позволяет запускать проверки и
  инсталлятор без загрузки всего ядра.
- **MVC‑админка**: URL `/admin` теперь обслуживается через контроллеры
  `AdminController`, `AdminCategoryController` и `AdminForumController` и
  защищён middleware `AdminOnly`.  Добавлены маршруты для просмотра и
  изменения настроек, управления категориями и форумами.  Маршруты
  определены в `routes/web.php`.
- **Раздел модератора `/mod`**: создан `ModController` и заглушка —
  шаблон `mod/index.blade.php`.  Доступ ограничивается middleware `ModOnly`.
- **Middleware ModOnly**: новый класс `App\Http\Middleware\ModOnly`
  разрешает доступ только пользователям с `role_id >= 3` (модераторы,
  супер‑модераторы, разработчики) и возвращает 403 для обычных
  пользователей.
- **Роль‑зависимая навигация**: `LayoutService` определяет
  `role_id` текущего пользователя и добавляет ссылки `admin` или `mod`
  в массив `nav.links`.  Шаблон `layouts.xen.nav` обновлён, чтобы
  отображать ссылки «Админка» и «Модератор» при наличии соответствующего
  ключа.
### Changed
- **Автозагрузчик в SafeMode**: в `public/admin/index.php` добавлен вызов
  `require_once $root . '/app/init.php'`, чтобы модули могли автоматически
  находить классы `App\Services\Admin\*`.  Это устраняет ошибки
  `Class ... not found` при открытии страниц `/admin/?page=stack` и
  `/admin/?page=checksum`.
- **routes/web.php**: версия файла обновлена до `v0.4.118`; добавлены
  маршруты админки и модераторской панели, а также импортированы новые
  контроллеры и middleware.
- **LayoutService**: теперь вычисляет флаги `is_admin`, `is_moder` и
  добавляет соответствующие ссылки в `nav.links`.  Также добавлено поле
  `is_moder` в `nav.auth`.
- **Навбар Xen**: шаблон `layouts/xen/nav.blade.php` переработан для
  использования `isset($layout['nav']['links']['admin'])` и
  `isset($layout['nav']['links']['mod'])` вместо проверки `is_admin`;
  добавлена ссылка «Модератор».
### Fixed
- **Не найденные классы в модулях SafeMode**: благодаря автозагрузчику
  `app/init.php` в админке, модули `_stack.php` и `_checksum.php`
  корректно подключают `App\Services\Admin\ContractChecker` и
  `ChecksumService`.  Исправлены ошибки вида
  `Fatal error: Class App\Services\Admin\ChecksumService not found`.
- **Ошибки Blade-шаблонов**: обновлённый навбар устраняет предупреждения
  «Unmatched '}'» при рендеринге `layouts.xen.nav.blade.php`.
### Removed
- **Старое расположение сервисных модулей**: пути
  `/admin/?page=service`, `/admin/?page=install`, `/admin/?page=stack` и
  `/admin/?page=checksum` больше не предназначены для SafeMode; они
  доступны только в аварийном режиме `/safemode/`.

---
## [v0.4.120] — 2025-09-14
### Fixed
- **Blade-шаблоны**: устранена ошибка компиляции «Unmatched '}'» в
  `layouts.xen.nav.blade.php`.  Обновление навбара гарантирует правильное
  закрытие директив и фигурных скобок.
- **SafeMode модули**: описание и кнопка «Пересчитать и сохранить хэши»
  в модуле контроля файлов, а также описание модуля проверки стека скрыты
  в сворачиваемый блок `<details>`.  Это улучшает визуальную
  компоновку страниц.
- **Проверка стека**: результаты анализа теперь отображаются в виде
  дерева с использованием `<details>`/`<summary>` для директорий и
  файлов.  В таблице показаны недостающие и лишние методы.
### Changed
- **config/app.php**: версия приложения обновлена до `0.4.120`.
- **README.md**: добавлен раздел «Что нового в v0.4.120».
## [v0.4.114] — 2025-09-13
### Fixed
- **Маршрутные параметры**: теперь `Router::executeAction` распаковывает
  параметры маршрута и передаёт их в контроллеры и замыкания через
  оператор `...$args`. Это исправляет ошибку `Argument #2 ($category_slug) must
  be of type string, array given`, возникавшую при открытии страниц категории,
  хаба и темы.
- **Отсутствие админки и стилей**: каталоги `public/style` и `public/admin` теперь
  дублируются в корень проекта (`/style`, `/admin`). Благодаря этому nginx
  успешно отдаёт файлы `/style/index.css`, `/style/forum.css` и страницу
  `/admin/index.php` даже при монтировании `/var/www/html` на корень. Пути к
  CSS в лейаутах и шаблонах возвращены на `/style/…`.

### Added
- **Восстановление админки**: URL `/admin/` снова доступен. Шаблоны админки
  не изменялись, а лишь перемещены. Авторизация по ключу `ADMIN_KEY` работает
  так же, как в предыдущих версиях. См. `docs/Admin.md`.

### Changed
- **config/app.php**: версия приложения обновлена до `0.4.114`.
- **resources/views/layouts/**: пути к стилям возвращены на `/style/index.css`;
  комментарии FIX обновлены, чтобы отразить перенос статики в корень.
- **resources/views/forum/**: шаблоны `category`, `topic`, `hub` снова
  подключают `/style/forum.css` и обновлены описания изменений.
- **framework/Faravel/Routing/Router.php**: обновлена логика вызова
  контроллеров и замыканий (см. раздел Fixed).

---

## [v0.4.115] — 2025-09-13
### Fixed
- **Главная страница (/)**: исправлена сигнатура замыкания в маршруте `/`.
  Теперь оно принимает только объект `Request`. После обновления
  `Router::executeAction` параметры маршрута передаются по одному, поэтому
  старое определение `function ($request, $params)` приводило к
  `ArgumentCountError`. Обновление устраняет ошибку «Too few arguments to
  function …» при первом запросе к сайту.

### Changed
- **config/app.php**: версия приложения поднята до `0.4.115`.
- **routes/web.php**: заголовок и комментарии обновлены, чтобы отразить
  исправление сигнатуры, и версия файла увеличена.
- **README.md**: добавлен раздел «Что нового в v0.4.115».

---
## [v0.4.112] — 2025-09-13
### Fixed
- **Подключение стилей**: добавлены вызовы `@stack('styles')` в базовые
  лейауты `layouts.theme` и `layouts.xen.theme`. Теперь директива
  `@push('styles')` из шаблонов форумных страниц корректно вставляет
  дополнительные CSS-файлы (например, `forum.css`) в `<head>`. Это устраняет
  проблему «корявого» отображения форума без стилей.

### Removed
- **RequestServiceProvider**: временный провайдер, использовавшийся для
  биндинга `Faravel\Http\Request`, полностью удалён из кода. Все биндинги
  выполняются в `AppServiceProvider`.

### Changed
- **config/app.php**: версия приложения обновлена до `0.4.112`.
- **README.md**: добавлен раздел «Что нового в v0.4.112» и приведено краткое
  описание улучшений.
- **Шапки файлов**: обновлены версии в заголовках `layouts.theme` и
  `layouts/xen.theme`.

---

## [v0.4.113] — 2025-09-13
### Fixed
- **404 для стилей**: во всех лейаутов (`layouts.xen.theme` и `layouts.theme`) и
  страничных шаблонах форума (`category`, `topic`, `hub`) пути к стилям
  заменены с `/style/…` на `/public/style/…`. Это исправляет ошибку
  «404 Not Found» при попытке загрузить `/style/index.css` и связанные файлы.
- **Обновлены версии файлов**: шапки изменённых представлений и лейаутов
  обновлены до актуальных патчей (0.4.113). Комментарии FIX дополнены
  пояснениями о причинах изменений.

### Changed
- **config/app.php**: версия приложения увеличена до `0.4.113`.
- **README.md**: добавлен раздел «Что нового в v0.4.113».
## [v0.4.110] — 2025-09-13
### Added
- **Возвращён AppServiceProvider**: главный провайдер снова зарегистрирован в
  конфигурации, что обеспечивает бинд `Faravel\Http\Request` и
  `Faravel\Http\ResponseFactory` в контейнере. Это устраняет ошибку
  «Container binding [Faravel\Http\ResponseFactory] not found.».
- **Переименование домашнего шаблона**: файл `home_redirect.blade.php`
  переименован в `home.blade.php`, а маршрут `/` теперь использует
  `response()->view('home')` для отдачи заглушки.

### Changed
- **config/app.php**: параметр `debug` установлен в `true` по умолчанию;
  список провайдеров обновлён — удалён `RequestServiceProvider`, добавлен
  `AppServiceProvider`. Версия приложения повышена до `0.4.110`.
- **README.md**: обновлен раздел «Что нового», отражены изменения версий.
- **TODO.md**: добавлены задачи по дальнейшей проработке функционала
  (см. файл).


Все заметные изменения этого проекта документируются в этом файле.

## [v0.4.108] — 2025-09-13
### Added
- **Домашняя страница‑заглушка**: маршрут `/` теперь возвращает 200 OK и
  рендерит страницу с приглашением «войти» на форум, вместо meta‑перенаправления.
- **Расширенные логи**: `App\Support\Logger` использует настоящий символ
  табуляции для разделения тега и сообщения, записывает файлы с правами
  0664/0775 и логирует класс, сообщение, файл, строку и метод/путь запроса
  при возникновении исключений в Kernel.
- **Безопасные права на логи**: создание каталога `storage/logs` и файла
  `debug.log` теперь сопровождается установкой режимов 0775 для папки и
  0664 для файла, позволяя пользователю `www-data` писать в них.

### Changed
- **Маршрут `/`**: исправлена сигнатура анонимной функции, принимающей
  `$request` и `$params`, что избавляет от `ArgumentCountError` и ошибки 500.
- **Kernel**: при обработке исключений теперь добавляет в лог метод и путь
  HTTP‑запроса. Заголовок версии обновлён до v0.4.108.
- **README.md**: добавлен раздел «Что нового в v0.4.108».

## [v0.4.7] — 2025-09-13
## [v0.4.8] — 2025-09-13
### Added
- **Система глубокого дебага**: внедрён новый класс `App\Support\Logger`
  и масштабное логирование по всему стеку (Application, Router, Kernel,
  провайдеры, middleware, контроллеры). Логи в формате `[TAG] Message`
  записываются в `storage/logs/debug.log` при включённом `app.debug`. Это
  позволяет проследить жизненный цикл запроса и локализовать ошибки 500.
- **Отладочные сообщения в провайдерах**: каждый сервис‑провайдер
  теперь пишет события регистрации и загрузки (`register`/`boot`) в лог.
- **Логирование маршрутов и действий**: Router записывает входящие
  запросы, совпадения маршрутов, выполнение middleware и контроллеров.
- **Обновление документации**: README дополнен разделом про систему дебага и
  инструкциями по включению логирования.

### Changed
- **Класс Application**: теперь логирует начало и конец регистрации
  провайдеров, загрузки маршрутов и фазы boot.
- **Kernel**: логирует выполнение каждого middleware и обрабатывает
  исключения с записью в лог.
- **Провайдеры**: добавлены вызовы `Logger::log()` в методы `register()`
  и `boot()` для генерации простых, читаемых сообщений о жизненном цикле.

### Added
- **Контрактные каркасы**: введены базовые интерфейсы для контроллеров
  (`InvokableControllerContract`) и сервисов (`ServiceContract`) в каталоге
  `app/Contracts`. Они стандартизируют публичные методы и облегчают
  разработку. Дополнен документ `docs/Contracts.md` описанием этих
  интерфейсов и правилами их применения.
- **Индекс документации**: добавлен `docs/index.md`, который содержит ссылки
  на основные разделы (SafeMode/Admin, архитектура, контракты, форумные
  данные, VM и т. д.).
- **Шаблон перенаправления**: создан `resources/views/home_redirect.blade.php`
  для отдачи кода 200 и мета‑перенаправления на `/forum/`.

### Updated
- **README.md**: добавлен раздел «Что нового в v0.4.7», информация о
  контрактных интерфейсах и ссылка на расширенную документацию.
- **docs/index.md**: обновлена запись о разделах, теперь «Контракты и
  интерфейсы» описывают файл‑хедеры и новые интерфейсы. Добавлена
  информация о структуре документации.
- **docs/Contracts.md**: расширен раздел про контрактные интерфейсы,
  добавлены рекомендации по их использованию в новом коде.

### Changed
- **Главный маршрут** `/` теперь возвращает 200 OK и HTML‑редирект вместо
  HTTP 302; устранена ошибка 500, возникавшая из‑за прежнего `Response::redirect()`.
- **Документация** переработана: объединён `forum-contracts.md`, в README
  добавлена ссылка на индекс документации.
- **Структура архива**: файлы проекта теперь упаковываются без внешней
  папки, чтобы `public/index.php` корректно подключался в контейнере.

## [v0.4.6] — 2025-09-11
### Added
- SafeMode Admin (единая панель `/admin/`): ключ-аутентификация по сессии.
- Модуль «Инсталлятор»: создание/удаление `public/installed.lock`.
- CLI-мигратор `tools/migrate.php` с флагом `--json` (машинный вывод).
- Документация по безопасности: `SECURITY.md`, обновлён `docs/Admin.md`.

### Changed
- Интеграция с `Faravel\Database\DatabaseAdmin` через корректные статические методы
  (`pingServer`, `databaseExists`, `createDatabaseIfNotExists`, `dropDatabase`,
  `canConnect`, `testReport`).
- Инсталлятор и сервисные проверки упрощены и унифицированы под админ-панель.

## [v0.4.4] — 2025-09-10
### Added
- Первичная версия SafeMode (сервисные утилиты), авторизация по ключу.
- Базовый раннер миграций `framework/migrator.php`.

---

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/). Нумерация версий — SemVer.
